<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SellerSync - Sales</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Mobile Menu Toggle -->
    <button class="hamburger" onclick="toggleSidebar()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18" />
        </svg>
    </button>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">SS</div>
                <span class="sidebar-title">SellerSync</span>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    Dashboard
                </a>
                <a href="sellers.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Sellers
                </a>
                <a href="stock.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    Stock
                </a>
                <a href="sales.html" class="nav-item active">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Sales
                </a>
                <a href="exhibitions.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    Exhibitions
                </a>
                <a href="payments.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Payments
                </a>
                <a href="reports.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Reports
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="nav-item" onclick="logout()">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Logout
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <header class="page-header">
                <div class="page-title">
                    <h1>Sales</h1>
                    <p>Record and track all sales transactions</p>
                </div>
                <div class="header-actions desktop-only">
                    <button class="btn btn-primary" onclick="openSaleModal()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <path d="M12 4v16m8-8H4" />
                        </svg>
                        Record Sale
                    </button>
                </div>
            </header>

            <!-- Mobile Add Button -->
            <button class="btn btn-primary mobile-add-btn" onclick="openSaleModal()">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 4v16m8-8H4" />
                </svg>
                Record Sale
            </button>

            <!-- Enhanced Summary Cards -->
            <style>
                .sales-stats {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 1.25rem;
                    margin-bottom: 1.5rem;
                }

                .sales-stat-card {
                    background: white;
                    border-radius: 16px;
                    padding: 1.5rem;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
                    border: 1px solid rgba(0, 0, 0, 0.04);
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    transition: transform 0.2s, box-shadow 0.2s;
                }

                .sales-stat-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
                }

                .stat-icon-box {
                    width: 56px;
                    height: 56px;
                    border-radius: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-shrink: 0;
                }

                .stat-icon-box.green {
                    background: linear-gradient(135deg, #11998e, #38ef7d);
                }

                .stat-icon-box.blue {
                    background: linear-gradient(135deg, #667eea, #764ba2);
                }

                .stat-icon-box.gold {
                    background: linear-gradient(135deg, #f2994a, #f2c94c);
                }

                .stat-icon-box svg {
                    color: white;
                    width: 28px;
                    height: 28px;
                }

                .stat-info {
                    flex: 1;
                }

                .stat-info .stat-label {
                    font-size: 0.8rem;
                    color: #64748b;
                    font-weight: 500;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 4px;
                }

                .stat-info .stat-value {
                    font-size: 1.75rem;
                    font-weight: 700;
                    color: #1e293b;
                    line-height: 1;
                }

                .filter-section {
                    background: white;
                    border-radius: 12px;
                    padding: 1rem 1.25rem;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
                    margin-bottom: 1.5rem;
                    display: flex;
                    gap: 1rem;
                    flex-wrap: wrap;
                    align-items: center;
                }

                .filter-section label {
                    font-size: 0.75rem;
                    color: #64748b;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 4px;
                    display: block;
                }

                .filter-section select {
                    padding: 0.5rem 2rem 0.5rem 0.75rem;
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    font-size: 0.875rem;
                    background: #f8fafc;
                    cursor: pointer;
                    min-width: 140px;
                }

                .filter-section select:focus {
                    outline: none;
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
                }

                .sales-table-card {
                    background: white;
                    border-radius: 16px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
                    overflow: hidden;
                }

                .sales-table-header {
                    padding: 1.25rem 1.5rem;
                    border-bottom: 1px solid #f1f5f9;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .sales-table-header h3 {
                    font-size: 1.1rem;
                    font-weight: 600;
                    color: #1e293b;
                    margin: 0;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                }

                .sales-table-header h3::before {
                    content: '';
                    width: 4px;
                    height: 20px;
                    background: linear-gradient(135deg, #11998e, #38ef7d);
                    border-radius: 4px;
                }
            </style>

            <div class="sales-stats">
                <div class="sales-stat-card">
                    <div class="stat-icon-box green">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Total Sales</div>
                        <div class="stat-value" id="totalSales">₹0</div>
                    </div>
                </div>
                <div class="sales-stat-card">
                    <div class="stat-icon-box blue">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path
                                d="M9 14l6-6m-5.5.5h.01m4.99 5h.01M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16l3.5-2 3.5 2 3.5-2 3.5 2z" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Total Profit</div>
                        <div class="stat-value" id="totalProfit">₹0</div>
                    </div>
                </div>
                <div class="sales-stat-card">
                    <div class="stat-icon-box gold">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path
                                d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Rolling Cash</div>
                        <div class="stat-value" id="rollingCash">₹0</div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Filters -->
            <div class="filter-section">
                <div>
                    <label>Seller</label>
                    <select id="filterSeller" onchange="loadSales()">
                        <option value="">All Sellers</option>
                    </select>
                </div>
                <div>
                    <label>Payment</label>
                    <select id="filterPayment" onchange="loadSales()">
                        <option value="">All</option>
                        <option value="cash">Cash</option>
                        <option value="online">Online</option>
                    </select>
                </div>
            </div>

            <!-- Enhanced Sales Table -->
            <div class="sales-table-card">
                <div class="sales-table-header">
                    <h3>Sales History</h3>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Item</th>
                                <th>Seller</th>
                                <th>Cost</th>
                                <th>Sold For</th>
                                <th>Profit</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salesTableBody">
                            <tr>
                                <td colspan="7" class="empty-state">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Record Sale Modal -->
    <div class="modal-overlay" id="saleModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3>Record Sale</h3>
                <button class="btn btn-icon btn-secondary" onclick="closeSaleModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="saleForm">
                    <div class="form-group">
                        <label class="form-label">Select Item to Sell *</label>
                        <select class="form-input" id="saleItem" required onchange="updateCostDisplay()">
                            <option value="">Select Item</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cost Price</label>
                        <input type="text" class="form-input" id="saleCostPrice" readonly
                            style="background: var(--gray-100);">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Selling Price (₹) *</label>
                        <input type="number" class="form-input" id="saleSellingPrice" placeholder="0.00" step="0.01"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Method</label>
                        <select class="form-input" id="salePaymentMethod">
                            <option value="cash">Cash</option>
                            <option value="online">Online</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sale Date *</label>
                        <input type="date" class="form-input" id="saleDate" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Notes</label>
                        <input type="text" class="form-input" id="saleNotes" placeholder="Optional notes">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSaleModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitSale()">Record Sale</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script src="js/api.js"></script>
    <script>
        let sales = [];
        let sellers = [];
        let stockItems = [];

        // Check auth
        if (!localStorage.getItem('token')) {
            window.location.href = 'login.html';
        }

        async function loadData() {
            await loadSellers();
            await loadAvailableStock();
            await loadSales();
            await loadSummary();

            // Check if coming from stock page with item to sell
            const urlParams = new URLSearchParams(window.location.search);
            const sellId = urlParams.get('sell');
            if (sellId) {
                openSaleModal(parseInt(sellId));
            }
        }

        async function loadSellers() {
            try {
                sellers = await api.get('/sellers');
                const filterSelect = document.getElementById('filterSeller');

                sellers.forEach(s => {
                    filterSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
            } catch (error) {
                showToast('Error loading sellers', 'error');
            }
        }

        async function loadAvailableStock() {
            try {
                stockItems = await api.get('/stock?status=in_stock');
                const select = document.getElementById('saleItem');
                select.innerHTML = '<option value="">Select Item</option>';

                stockItems.forEach(item => {
                    select.innerHTML += `<option value="${item.id}" data-cost="${item.cost_price}">${item.item_name} (${item.seller_name}) - ₹${parseFloat(item.cost_price).toLocaleString('en-IN')}</option>`;
                });
            } catch (error) {
                console.error('Error loading stock:', error);
            }
        }

        async function loadSales() {
            try {
                const sellerId = document.getElementById('filterSeller').value;
                const paymentMethod = document.getElementById('filterPayment').value;

                let url = '/sales?';
                if (sellerId) url += `seller_id=${sellerId}&`;
                if (paymentMethod) url += `payment_method=${paymentMethod}`;

                sales = await api.get(url);
                renderSales();
            } catch (error) {
                showToast('Error loading sales', 'error');
            }
        }

        async function loadSummary() {
            try {
                const summary = await api.get('/sales/summary');
                document.getElementById('totalSales').textContent = '₹' + parseFloat(summary.totalSales).toLocaleString('en-IN');
                document.getElementById('totalProfit').textContent = '₹' + parseFloat(summary.profit).toLocaleString('en-IN');
                document.getElementById('rollingCash').textContent = '₹' + parseFloat(summary.rollingCash).toLocaleString('en-IN');
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('en-IN', { day: '2-digit', month: 'short', year: 'numeric' });
        }

        function renderSales() {
            const tbody = document.getElementById('salesTableBody');

            if (sales.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-state">No sales recorded yet</td></tr>';
                return;
            }

            tbody.innerHTML = sales.map(sale => {
                const profit = parseFloat(sale.selling_price) - parseFloat(sale.cost_price);
                const profitClass = profit >= 0 ? 'amount-positive' : 'amount-negative';

                return `
                    <tr>
                        <td data-label="Date">${formatDate(sale.sale_date)}</td>
                        <td data-label="Item">${sale.item_name}</td>
                        <td data-label="Seller">${sale.seller_name}</td>
                        <td data-label="Cost" class="amount">₹${parseFloat(sale.cost_price).toLocaleString('en-IN')}</td>
                        <td data-label="Sold For" class="amount">₹${parseFloat(sale.selling_price).toLocaleString('en-IN')}</td>
                        <td data-label="Profit" class="amount ${profitClass}">₹${profit.toLocaleString('en-IN')}</td>
                        <td data-label="Actions">
                            <button class="btn btn-sm btn-danger" onclick="deleteSale(${sale.id})" title="Delete">
                                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                    <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                </svg>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function openSaleModal(preselectedItemId = null) {
            document.getElementById('saleForm').reset();
            document.getElementById('saleDate').value = new Date().toISOString().split('T')[0];
            document.getElementById('saleCostPrice').value = '';

            if (preselectedItemId) {
                document.getElementById('saleItem').value = preselectedItemId;
                updateCostDisplay();
            }

            document.getElementById('saleModal').classList.add('active');
        }

        function closeSaleModal() {
            document.getElementById('saleModal').classList.remove('active');
        }

        function updateCostDisplay() {
            const select = document.getElementById('saleItem');
            const option = select.options[select.selectedIndex];
            const cost = option.dataset.cost || '';
            document.getElementById('saleCostPrice').value = cost ? '₹' + parseFloat(cost).toLocaleString('en-IN') : '';
        }

        async function submitSale() {
            const data = {
                stock_item_id: document.getElementById('saleItem').value,
                selling_price: document.getElementById('saleSellingPrice').value,
                payment_method: document.getElementById('salePaymentMethod').value,
                sale_date: document.getElementById('saleDate').value,
                notes: document.getElementById('saleNotes').value
            };

            if (!data.stock_item_id || !data.selling_price || !data.sale_date) {
                showToast('Please fill all required fields', 'error');
                return;
            }

            try {
                await api.post('/sales', data);
                showToast('Sale recorded successfully', 'success');
                closeSaleModal();
                loadAvailableStock();
                loadSales();
                loadSummary();
            } catch (error) {
                showToast(error.message || 'Error recording sale', 'error');
            }
        }

        async function deleteSale(id) {
            if (!confirm('Delete this sale? The item will be restored to stock.')) return;

            try {
                await api.delete(`/sales/${id}`);
                showToast('Sale deleted, item restored to stock', 'success');
                loadAvailableStock();
                loadSales();
                loadSummary();
            } catch (error) {
                showToast(error.message || 'Error deleting sale', 'error');
            }
        }

        // Close modal on Escape key
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Escape') {
                closeSaleModal();
            }
        });

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Init
        loadData();
    </script>
</body>

</html>