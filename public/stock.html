<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SellerSync - Stock</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    <!-- Mobile Menu Toggle -->
    <button class="hamburger" onclick="toggleSidebar()">
        <svg width="24" height="24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M3 12h18M3 6h18M3 18h18" />
        </svg>
    </button>

    <div class="app-container">
        <!-- Sidebar -->
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">SS</div>
                <span class="sidebar-title">SellerSync</span>
            </div>
            <nav class="sidebar-nav">
                <a href="index.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                    </svg>
                    Dashboard
                </a>
                <a href="sellers.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Sellers
                </a>
                <a href="stock.html" class="nav-item active">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                    </svg>
                    Stock
                </a>
                <a href="sales.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Sales
                </a>
                <a href="payments.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M17 9V7a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2m2 4h10a2 2 0 002-2v-6a2 2 0 00-2-2H9a2 2 0 00-2 2v6a2 2 0 002 2zm7-5a2 2 0 11-4 0 2 2 0 014 0z" />
                    </svg>
                    Payments
                </a>
                <a href="reports.html" class="nav-item">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    Reports
                </a>
            </nav>
            <div class="sidebar-footer">
                <div class="nav-item" onclick="logout()">
                    <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path
                            d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                    </svg>
                    Logout
                </div>
            </div>
        </aside>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <header class="page-header">
                <div class="page-title">
                    <h1>Stock</h1>
                    <p>Manage your inventory items</p>
                </div>
                <div class="header-actions desktop-only">
                    <button class="btn btn-primary" onclick="openStockModal()">
                        <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2"
                            viewBox="0 0 24 24">
                            <path d="M12 4v16m8-8H4" />
                        </svg>
                        Add Stock
                    </button>
                </div>
            </header>

            <!-- Mobile Add Button -->
            <button class="btn btn-primary mobile-add-btn" onclick="openStockModal()">
                <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                    <path d="M12 4v16m8-8H4" />
                </svg>
                Add Stock Item
            </button>

            <!-- Enhanced Summary Cards -->
            <style>
                .stock-stats {
                    display: grid;
                    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                    gap: 1.25rem;
                    margin-bottom: 1.5rem;
                }

                .stock-stat-card {
                    background: white;
                    border-radius: 16px;
                    padding: 1.5rem;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
                    border: 1px solid rgba(0, 0, 0, 0.04);
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    transition: transform 0.2s, box-shadow 0.2s;
                }

                .stock-stat-card:hover {
                    transform: translateY(-2px);
                    box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
                }

                .stat-icon-box {
                    width: 56px;
                    height: 56px;
                    border-radius: 14px;
                    display: flex;
                    align-items: center;
                    justify-content: center;
                    flex-shrink: 0;
                }

                .stat-icon-box.purple {
                    background: linear-gradient(135deg, #667eea, #764ba2);
                }

                .stat-icon-box.green {
                    background: linear-gradient(135deg, #11998e, #38ef7d);
                }

                .stat-icon-box.orange {
                    background: linear-gradient(135deg, #f093fb, #f5576c);
                }

                .stat-icon-box svg {
                    color: white;
                    width: 28px;
                    height: 28px;
                }

                .stat-info {
                    flex: 1;
                }

                .stat-info .stat-label {
                    font-size: 0.8rem;
                    color: #64748b;
                    font-weight: 500;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 4px;
                }

                .stat-info .stat-value {
                    font-size: 1.75rem;
                    font-weight: 700;
                    color: #1e293b;
                    line-height: 1;
                }

                .filter-section {
                    background: white;
                    border-radius: 12px;
                    padding: 1rem 1.25rem;
                    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
                    margin-bottom: 1.5rem;
                    display: flex;
                    gap: 1rem;
                    flex-wrap: wrap;
                    align-items: center;
                }

                .filter-section label {
                    font-size: 0.75rem;
                    color: #64748b;
                    font-weight: 600;
                    text-transform: uppercase;
                    letter-spacing: 0.5px;
                    margin-bottom: 4px;
                    display: block;
                }

                .filter-section select {
                    padding: 0.5rem 2rem 0.5rem 0.75rem;
                    border: 1px solid #e2e8f0;
                    border-radius: 8px;
                    font-size: 0.875rem;
                    background: #f8fafc;
                    cursor: pointer;
                    min-width: 140px;
                }

                .filter-section select:focus {
                    outline: none;
                    border-color: #667eea;
                    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.15);
                }

                .stock-table-card {
                    background: white;
                    border-radius: 16px;
                    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.06);
                    overflow: hidden;
                }

                .stock-table-header {
                    padding: 1.25rem 1.5rem;
                    border-bottom: 1px solid #f1f5f9;
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                }

                .stock-table-header h3 {
                    font-size: 1.1rem;
                    font-weight: 600;
                    color: #1e293b;
                    margin: 0;
                    display: flex;
                    align-items: center;
                    gap: 0.5rem;
                }

                .stock-table-header h3::before {
                    content: '';
                    width: 4px;
                    height: 20px;
                    background: linear-gradient(135deg, #667eea, #764ba2);
                    border-radius: 4px;
                }

                /* Modal Styles */
                .modal {
                    display: none;
                    position: fixed;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: rgba(0, 0, 0, 0.5);
                    z-index: 1000;
                    overflow-y: auto;
                    padding: 2rem 1rem;
                }

                .modal.active {
                    display: flex;
                    align-items: flex-start;
                    justify-content: center;
                }

                .modal-content {
                    background: white;
                    border-radius: 16px;
                    width: 100%;
                    max-width: 500px;
                    margin: auto;
                    box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
                }

                .modal-header {
                    display: flex;
                    justify-content: space-between;
                    align-items: center;
                    padding: 1.25rem 1.5rem;
                    border-bottom: 1px solid #e2e8f0;
                }

                .modal-header h2 {
                    font-size: 1.25rem;
                    font-weight: 600;
                    color: #1e293b;
                    margin: 0;
                }

                .modal-close {
                    background: none;
                    border: none;
                    font-size: 1.5rem;
                    cursor: pointer;
                    color: #64748b;
                    padding: 0.25rem;
                    line-height: 1;
                }

                .modal-close:hover {
                    color: #1e293b;
                }

                .modal-body {
                    padding: 1.5rem;
                }

                .modal-footer {
                    display: flex;
                    justify-content: flex-end;
                    gap: 0.75rem;
                    padding: 1rem 1.5rem;
                    border-top: 1px solid #e2e8f0;
                    background: #f8fafc;
                    border-radius: 0 0 16px 16px;
                }
            </style>

            <div class="stock-stats">
                <div class="stock-stat-card">
                    <div class="stat-icon-box purple">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Items in Stock</div>
                        <div class="stat-value" id="stockCount">0</div>
                    </div>
                </div>
                <div class="stock-stat-card">
                    <div class="stat-icon-box green">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path
                                d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Stock Value</div>
                        <div class="stat-value" id="stockValue">₹0</div>
                    </div>
                </div>
                <div class="stock-stat-card">
                    <div class="stat-icon-box orange">
                        <svg fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                            <path d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                    </div>
                    <div class="stat-info">
                        <div class="stat-label">Items Sold</div>
                        <div class="stat-value" id="soldCount">0</div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Filters -->
            <div class="filter-section">
                <div>
                    <label>Seller</label>
                    <select id="filterSeller" onchange="loadStock()">
                        <option value="">All Sellers</option>
                    </select>
                </div>
                <div>
                    <label>Status</label>
                    <select id="filterStatus" onchange="loadStock()">
                        <option value="">All Status</option>
                        <option value="in_stock" selected>In Stock</option>
                        <option value="sold">Sold</option>
                    </select>
                </div>
            </div>

            <!-- Enhanced Stock Table -->
            <div class="stock-table-card">
                <div class="stock-table-header">
                    <h3>Stock Items</h3>
                </div>
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Item Name</th>
                                <th>Seller</th>
                                <th>Cost Price</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <tr>
                                <td colspan="5" class="empty-state">Loading...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <!-- Add/Edit Stock Modal -->
    <div class="modal-overlay" id="stockModal">
        <div class="modal" style="max-width: 500px;">
            <div class="modal-header">
                <h3 id="stockModalTitle">Add Stock Item</h3>
                <button class="btn btn-icon btn-secondary" onclick="closeStockModal()">
                    <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                        <path d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <form id="stockForm">
                    <input type="hidden" id="stockId">
                    <div class="form-group">
                        <label class="form-label">Seller *</label>
                        <select class="form-input" id="stockSeller" required>
                            <option value="">Select Seller</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Item Name *</label>
                        <input type="text" class="form-input" id="stockItemName" placeholder="e.g., Red Silk Saree"
                            required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cost Price (₹) *</label>
                        <input type="number" class="form-input" id="stockCostPrice" placeholder="0.00" step="0.01"
                            required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeStockModal()">Cancel</button>
                <button class="btn btn-primary" onclick="submitStock()">Save Item</button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <script src="js/api.js"></script>
    <script>
        let stockItems = [];
        let sellers = [];

        // Check auth
        if (!localStorage.getItem('token')) {
            window.location.href = 'login.html';
        }

        async function loadData() {
            await loadSellers();
            await loadStock();
            await loadSummary();
        }

        async function loadSellers() {
            try {
                sellers = await api.get('/sellers');
                const filterSelect = document.getElementById('filterSeller');
                const formSelect = document.getElementById('stockSeller');

                sellers.forEach(s => {
                    filterSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                    formSelect.innerHTML += `<option value="${s.id}">${s.name}</option>`;
                });
            } catch (error) {
                showToast('Error loading sellers', 'error');
            }
        }

        async function loadStock() {
            try {
                const sellerId = document.getElementById('filterSeller').value;
                const status = document.getElementById('filterStatus').value;

                let url = '/stock?';
                if (sellerId) url += `seller_id=${sellerId}&`;
                if (status) url += `status=${status}`;

                stockItems = await api.get(url);
                renderStock();
            } catch (error) {
                showToast('Error loading stock', 'error');
            }
        }

        async function loadSummary() {
            try {
                const summary = await api.get('/stock/summary');
                document.getElementById('stockValue').textContent = '₹' + parseFloat(summary.totalStockValue).toLocaleString('en-IN');

                let inStock = 0, sold = 0;
                summary.stockCount.forEach(c => {
                    if (c.status === 'in_stock') inStock = c.count;
                    if (c.status === 'sold') sold = c.count;
                });
                document.getElementById('stockCount').textContent = inStock;
                document.getElementById('soldCount').textContent = sold;
            } catch (error) {
                console.error('Error loading summary:', error);
            }
        }

        function renderStock() {
            const tbody = document.getElementById('stockTableBody');

            if (stockItems.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="empty-state">No stock items found</td></tr>';
                return;
            }

            tbody.innerHTML = stockItems.map(item => `
                <tr>
                    <td data-label="Item">${item.item_name}</td>
                    <td data-label="Seller">${item.seller_name}</td>
                    <td data-label="Cost Price" class="amount">₹${parseFloat(item.cost_price).toLocaleString('en-IN')}</td>
                    <td data-label="Status">
                        <span class="badge ${item.status === 'in_stock' ? 'badge-success' : 'badge-warning'}">
                            ${item.status === 'in_stock' ? 'In Stock' : 'Sold'}
                        </span>
                    </td>
                    <td data-label="Actions">
                        <div class="action-buttons">
                            ${item.status === 'in_stock' ? `
                                <button class="btn btn-sm btn-success" onclick="sellItem(${item.id})" title="Sell">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
                                    </svg>
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="editStock(${item.id})" title="Edit">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                                    </svg>
                                </button>
                                <button class="btn btn-sm btn-danger" onclick="deleteStock(${item.id})" title="Delete">
                                    <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24">
                                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                                    </svg>
                                </button>
                            ` : `
                                <span class="text-muted">-</span>
                            `}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openStockModal() {
            document.getElementById('stockModalTitle').textContent = 'Add Stock Item';
            document.getElementById('stockForm').reset();
            document.getElementById('stockId').value = '';
            document.getElementById('stockModal').classList.add('active');
        }

        function closeStockModal() {
            document.getElementById('stockModal').classList.remove('active');
        }

        function editStock(id) {
            const item = stockItems.find(i => i.id === id);
            if (!item) return;

            document.getElementById('stockId').value = item.id;
            document.getElementById('stockSeller').value = item.seller_id;
            document.getElementById('stockItemName').value = item.item_name;
            document.getElementById('stockCostPrice').value = item.cost_price;

            document.getElementById('stockModalTitle').textContent = 'Edit Stock Item';
            document.getElementById('stockModal').classList.add('active');
        }

        async function submitStock() {
            const id = document.getElementById('stockId').value;
            const data = {
                seller_id: document.getElementById('stockSeller').value,
                item_name: document.getElementById('stockItemName').value,
                cost_price: document.getElementById('stockCostPrice').value
            };

            if (!data.seller_id || !data.item_name || !data.cost_price) {
                showToast('Please fill all required fields', 'error');
                return;
            }

            try {
                if (id) {
                    await api.put(`/stock/${id}`, data);
                    showToast('Stock item updated', 'success');
                } else {
                    await api.post('/stock', data);
                    showToast('Stock item added', 'success');
                }
                closeStockModal();
                loadStock();
                loadSummary();
            } catch (error) {
                showToast(error.message || 'Error saving stock item', 'error');
            }
        }

        async function deleteStock(id) {
            if (!confirm('Delete this stock item?')) return;

            try {
                await api.delete(`/stock/${id}`);
                showToast('Stock item deleted', 'success');
                loadStock();
                loadSummary();
            } catch (error) {
                showToast(error.message || 'Error deleting stock item', 'error');
            }
        }

        function sellItem(id) {
            // Redirect to sales page with item pre-selected
            window.location.href = `sales.html?sell=${id}`;
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('open');
        }

        function logout() {
            localStorage.removeItem('token');
            localStorage.removeItem('user');
            window.location.href = 'login.html';
        }

        // Init
        loadData();
    </script>
</body>

</html>